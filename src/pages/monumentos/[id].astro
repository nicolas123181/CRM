---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import { supabase } from "../../lib/supabase";
import type { Monumento } from "../../types/database.types";

const { id } = Astro.params;

// Fetch monumento
const { data: monumento, error } = await supabase
    .from("monumentos")
    .select("*")
    .eq("id", id)
    .single();

if (error || !monumento) {
    return Astro.redirect("/monumentos");
}

const mon = monumento as Monumento;

// Fetch ALL clicks statistics (general, not limited by time)
const { data: clicks } = await supabase
    .from("clicks_monumentos")
    .select("id, fecha, edad")
    .eq("monumento_id", id);

// Calculate statistics
const totalClicks = clicks?.length || 0;
const clicksWithAge = clicks?.filter((c) => c.edad !== null) || [];
const avgAge =
    clicksWithAge.length > 0
        ? Math.round(
              clicksWithAge.reduce((sum, c) => sum + (c.edad || 0), 0) /
                  clicksWithAge.length,
          )
        : null;

// Age distribution
const ageGroups = {
    "18-24": 0,
    "25-34": 0,
    "35-44": 0,
    "45-54": 0,
    "55-64": 0,
    "65+": 0,
};

clicksWithAge.forEach((c) => {
    const age = c.edad || 0;
    if (age >= 18 && age <= 24) ageGroups["18-24"]++;
    else if (age >= 25 && age <= 34) ageGroups["25-34"]++;
    else if (age >= 35 && age <= 44) ageGroups["35-44"]++;
    else if (age >= 45 && age <= 54) ageGroups["45-54"]++;
    else if (age >= 55 && age <= 64) ageGroups["55-64"]++;
    else if (age >= 65) ageGroups["65+"]++;
});

// Clicks by month (all time grouped by month)
const clicksByMonth: Record<string, number> = {};
clicks?.forEach((c) => {
    if (c.fecha) {
        const month = c.fecha.substring(0, 7); // YYYY-MM
        clicksByMonth[month] = (clicksByMonth[month] || 0) + 1;
    }
});

// Get sorted months
const sortedMonths = Object.keys(clicksByMonth).sort();
const chartLabels = sortedMonths.map((m) => {
    const [year, month] = m.split("-");
    const date = new Date(parseInt(year), parseInt(month) - 1);
    return date.toLocaleDateString("es-ES", {
        month: "short",
        year: "2-digit",
    });
});
const chartData = sortedMonths.map((m) => clicksByMonth[m]);

// Influence zone radius (500m)
const influenceRadius = 0.5; // km
---

<Layout title={mon.nombre}>
    <Navbar />

    <main class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="animate-fade-in">
            <!-- Breadcrumb -->
            <nav class="flex mb-8" aria-label="Breadcrumb">
                <ol role="list" class="flex items-center space-x-4">
                    <li>
                        <a
                            href="/monumentos"
                            class="text-gray-400 hover:text-gray-500"
                        >
                            <svg
                                class="h-5 w-5"
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
                                ></path>
                            </svg>
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg
                                class="h-5 w-5 text-gray-300"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z"
                                ></path>
                            </svg>
                            <a
                                href="/monumentos"
                                class="ml-4 text-sm font-medium text-gray-500 hover:text-gray-700"
                                >Monumentos</a
                            >
                        </div>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg
                                class="h-5 w-5 text-gray-300"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z"
                                ></path>
                            </svg>
                            <span class="ml-4 text-sm font-medium text-gray-500"
                                >{mon.nombre}</span
                            >
                        </div>
                    </li>
                </ol>
            </nav>

            <!-- Header Card -->
            <div
                class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-xl overflow-hidden mb-6"
            >
                <div class="md:flex">
                    {
                        mon.imagen_url ? (
                            <div class="md:w-1/3 h-64 md:h-auto overflow-hidden">
                                <img
                                    src={mon.imagen_url}
                                    alt={mon.nombre}
                                    class="w-full h-full object-cover"
                                />
                            </div>
                        ) : (
                            <div class="md:w-1/3 h-64 md:h-auto bg-gradient-to-br from-amber-100 to-amber-200 flex items-center justify-center">
                                <span class="text-8xl">üèõÔ∏è</span>
                            </div>
                        )
                    }
                    <div class="md:w-2/3 p-6">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="flex items-center gap-3 mb-2">
                                    {
                                        mon.orden && mon.orden > 0 && (
                                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-amber-100 text-amber-800 text-sm font-bold">
                                                #{mon.orden}
                                            </span>
                                        )
                                    }
                                    {
                                        mon.audio_url && (
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                                                üîä Audiogu√≠a
                                            </span>
                                        )
                                    }
                                </div>
                                <h1 class="text-2xl font-bold text-gray-900">
                                    {mon.nombre}
                                </h1>
                                {
                                    mon.descripcion && (
                                        <p class="mt-3 text-gray-600 leading-relaxed">
                                            {mon.descripcion}
                                        </p>
                                    )
                                }
                            </div>
                            <a
                                href={`/monumentos/edit/${mon.id}`}
                                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                            >
                                ‚úèÔ∏è Editar
                            </a>
                        </div>

                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div
                                class="flex items-center text-sm text-gray-600"
                            >
                                <span class="mr-2">üìç</span>
                                <a
                                    href={`https://www.google.com/maps?q=${mon.latitud},${mon.longitud}`}
                                    target="_blank"
                                    class="text-amber-600 hover:underline"
                                >
                                    Ver en Maps
                                </a>
                            </div>
                            {
                                mon.horario && (
                                    <div class="flex items-center text-sm text-gray-600">
                                        <span class="mr-2">üïê</span>
                                        {mon.horario}
                                    </div>
                                )
                            }
                        </div>

                        {
                            mon.audio_url && (
                                <div class="mt-4 p-3 bg-purple-50 rounded-lg border border-purple-100">
                                    <p class="text-xs text-purple-700 mb-2 font-medium">
                                        Audiogu√≠a disponible:
                                    </p>
                                    <audio controls class="w-full h-10">
                                        <source
                                            src={mon.audio_url}
                                            type="audio/mpeg"
                                        />
                                    </audio>
                                </div>
                            )
                        }
                    </div>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="grid gap-6 md:grid-cols-3 mb-6">
                <!-- Total Clicks Card -->
                <div
                    class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl p-6 text-white shadow-lg"
                >
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-amber-100 text-sm font-medium">
                                Total de Visitas
                            </p>
                            <p class="text-4xl font-bold mt-1">
                                {totalClicks.toLocaleString()}
                            </p>
                            <p class="text-amber-200 text-xs mt-2">
                                Desde el inicio
                            </p>
                        </div>
                        <div class="text-5xl opacity-30">üëÅÔ∏è</div>
                    </div>
                </div>

                <!-- Average Age Card -->
                <div
                    class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl p-6 text-white shadow-lg"
                >
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm font-medium">
                                Edad Media
                            </p>
                            <p class="text-4xl font-bold mt-1">
                                {avgAge || "N/A"}
                            </p>
                            <p class="text-purple-200 text-xs mt-2">
                                a√±os de media
                            </p>
                        </div>
                        <div class="text-5xl opacity-30">üë§</div>
                    </div>
                </div>

                <!-- Influence Zone Card -->
                <div
                    class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl p-6 text-white shadow-lg"
                >
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-emerald-100 text-sm font-medium">
                                Zona de Influencia
                            </p>
                            <p class="text-4xl font-bold mt-1">500 m</p>
                            <p class="text-emerald-200 text-xs mt-2">
                                radio de alcance
                            </p>
                        </div>
                        <div class="text-5xl opacity-30">üìç</div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid gap-6 md:grid-cols-2 mb-6">
                <!-- Age Distribution Chart -->
                <div
                    class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-xl overflow-hidden"
                >
                    <div
                        class="px-5 py-4 bg-gradient-to-r from-purple-500 to-indigo-600 border-b"
                    >
                        <h3 class="text-lg font-semibold text-white">
                            üìä Distribuci√≥n por Edad
                        </h3>
                        <p class="text-purple-200 text-xs mt-1">
                            Perfil demogr√°fico de visitantes
                        </p>
                    </div>
                    <div class="p-5">
                        {
                            totalClicks > 0 ? (
                                <div class="space-y-3">
                                    {Object.entries(ageGroups).map(
                                        ([range, count]) => {
                                            const percentage =
                                                clicksWithAge.length > 0
                                                    ? (count /
                                                          clicksWithAge.length) *
                                                      100
                                                    : 0;
                                            return (
                                                <div class="flex items-center">
                                                    <span class="text-sm text-gray-600 w-16 font-medium">
                                                        {range}
                                                    </span>
                                                    <div class="flex-1 mx-3">
                                                        <div class="h-6 bg-gray-100 rounded-full overflow-hidden">
                                                            <div
                                                                class="h-full bg-gradient-to-r from-purple-400 to-indigo-500 rounded-full transition-all duration-700 flex items-center justify-end pr-2"
                                                                style={`width: ${Math.max(percentage, 5)}%`}
                                                            >
                                                                {percentage >
                                                                    15 && (
                                                                    <span class="text-white text-xs font-medium">
                                                                        {Math.round(
                                                                            percentage,
                                                                        )}
                                                                        %
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <span class="text-sm font-bold text-gray-700 w-10 text-right">
                                                        {count}
                                                    </span>
                                                </div>
                                            );
                                        },
                                    )}
                                </div>
                            ) : (
                                <div class="text-center py-8 text-gray-500 text-sm">
                                    <span class="text-3xl block mb-2">üì≠</span>
                                    A√∫n no hay datos de visitantes
                                </div>
                            )
                        }
                    </div>
                </div>

                <!-- Visits Over Time Chart -->
                <div
                    class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-xl overflow-hidden"
                >
                    <div
                        class="px-5 py-4 bg-gradient-to-r from-amber-500 to-orange-600 border-b"
                    >
                        <h3 class="text-lg font-semibold text-white">
                            üìà Evoluci√≥n de Visitas
                        </h3>
                        <p class="text-amber-200 text-xs mt-1">
                            Hist√≥rico mensual completo
                        </p>
                    </div>
                    <div class="p-5">
                        {
                            totalClicks > 0 && chartLabels.length > 0 ? (
                                <div class="relative h-52">
                                    <canvas id="visitsChart" />
                                </div>
                            ) : (
                                <div class="text-center py-8 text-gray-500 text-sm">
                                    <span class="text-3xl block mb-2">üìä</span>
                                    El gr√°fico aparecer√° con datos
                                </div>
                            )
                        }
                    </div>
                </div>
            </div>

            <!-- Influence Zone Map -->
            <div
                class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-xl overflow-hidden mb-6"
            >
                <div
                    class="px-5 py-4 bg-gradient-to-r from-emerald-500 to-teal-600 border-b"
                >
                    <h3 class="text-lg font-semibold text-white">
                        üó∫Ô∏è Zona de Influencia (500m)
                    </h3>
                    <p class="text-emerald-200 text-xs mt-1">
                        Alcance potencial de publicidad para negocios cercanos
                    </p>
                </div>
                <div class="relative">
                    <div id="influenceMap" class="h-80 w-full"></div>
                    <div
                        class="absolute bottom-4 left-4 bg-white/95 backdrop-blur-sm rounded-lg shadow-lg p-3 text-sm"
                    >
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-amber-500"
                                ></span>
                                <span class="text-gray-700">Monumento</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span
                                    class="w-3 h-3 rounded-full bg-emerald-400/40 border-2 border-emerald-500"
                                ></span>
                                <span class="text-gray-700">Zona 500m</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-5 bg-emerald-50 border-t border-emerald-100">
                    <h4 class="text-sm font-semibold text-emerald-500 mb-2">
                        üí° Oportunidad Comercial
                    </h4>
                    <p class="text-sm text-emerald-700">
                        Los negocios dentro de la zona de 500m pueden
                        beneficiarse de la afluencia de <strong
                            >{totalClicks.toLocaleString()} visitantes</strong
                        >
                        registrados en este monumento. Ideal para promociones cruzadas
                        y publicidad local.
                    </p>
                </div>
            </div>

            <!-- Footer Actions -->
            <div
                class="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-xl px-6 py-4 flex justify-between items-center"
            >
                <a
                    href="/monumentos"
                    class="text-sm text-gray-600 hover:text-gray-900"
                    >‚Üê Volver a monumentos</a
                >
                <form
                    method="POST"
                    action="/monumentos"
                    onsubmit="return confirm('¬øEliminar este monumento?')"
                >
                    <input type="hidden" name="action" value="delete" />
                    <input type="hidden" name="monumentoId" value={mon.id} />
                    <button
                        type="submit"
                        class="text-sm text-red-600 hover:text-red-800 font-medium"
                        >üóëÔ∏è Eliminar</button
                    >
                </form>
            </div>
        </div>
    </main>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Leaflet JS -->
    <script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    ></script>

    <!-- Chart.js -->
    <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script
        is:inline
        define:vars={{
            chartLabels,
            chartData,
            totalClicks,
            monLat: mon.latitud,
            monLng: mon.longitud,
            influenceRadius,
        }}
    >
        document.addEventListener("DOMContentLoaded", function () {
            // Initialize Map
            if (typeof L !== "undefined") {
                const map = L.map("influenceMap").setView([monLat, monLng], 14);

                L.tileLayer(
                    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                    {
                        attribution: "¬© OpenStreetMap contributors",
                    },
                ).addTo(map);

                // Monument marker
                const monumentIcon = L.divIcon({
                    html: '<div style="font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üèõÔ∏è</div>',
                    className: "monument-marker",
                    iconSize: [36, 36],
                    iconAnchor: [18, 18],
                });

                L.marker([monLat, monLng], { icon: monumentIcon })
                    .addTo(map)
                    .bindPopup(
                        "<strong>üìç " +
                            document.querySelector("h1").textContent +
                            "</strong>",
                    );

                // Influence zone circle (2km = 2000m)
                L.circle([monLat, monLng], {
                    color: "#10b981",
                    fillColor: "#10b981",
                    fillOpacity: 0.15,
                    weight: 2,
                    radius: influenceRadius * 1000,
                }).addTo(map);

                // Fit bounds to show the circle
                const bounds = L.latLng(monLat, monLng).toBounds(
                    influenceRadius * 1000 * 2.2,
                );
                map.fitBounds(bounds);
            }

            // Initialize Chart
            if (
                totalClicks > 0 &&
                typeof Chart !== "undefined" &&
                chartLabels.length > 0
            ) {
                const ctx = document.getElementById("visitsChart");
                if (ctx) {
                    new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels: chartLabels,
                            datasets: [
                                {
                                    label: "Visitas",
                                    data: chartData,
                                    backgroundColor: "rgba(245, 158, 11, 0.7)",
                                    borderColor: "rgba(245, 158, 11, 1)",
                                    borderWidth: 1,
                                    borderRadius: 4,
                                    hoverBackgroundColor:
                                        "rgba(245, 158, 11, 0.9)",
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: "rgba(0, 0, 0, 0.8)",
                                    padding: 12,
                                },
                            },
                            scales: {
                                x: {
                                    grid: { display: false },
                                    ticks: {
                                        font: { size: 10 },
                                        color: "#6b7280",
                                    },
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: { color: "rgba(0,0,0,0.05)" },
                                    ticks: {
                                        stepSize: 1,
                                        font: { size: 10 },
                                        color: "#6b7280",
                                    },
                                },
                            },
                        },
                    });
                }
            }
        });
    </script>

    <style>
        .monument-marker {
            background: transparent;
            border: none;
        }
    </style>
</Layout>
